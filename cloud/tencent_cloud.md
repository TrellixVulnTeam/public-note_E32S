# 一、基础
## 1.CVM(Cloud Virtual Machine)

# 二、网络
## 1.CLB(Cloud Load Balancer)
* CloudLoadBalancer：负载均衡实例，用于流量分发。
* VIP(virtual IP)：负载均衡向客户端提供服务的 IP 地址。
* Backend/Real Server：后端一组云服务器实例，用于实际处理请求。
* VPC/基础网络：整体网络环境。

负载均衡，访问流量经由 CLB 可以自动分配到云中的多台云服务器上，扩展系统的服务能力并消除单点故障。
| 术语 | 全称 | 说明 |
| ------ | ------ | ------ |
| 负载均衡器 | Cloud Load Balancer | 腾讯云提供的一种网络负载均衡服务，可以结合 CVM 云服务器为用户提供基于 TCP/UDP 以及 HTTP 负载均衡服务 |
| 负载均衡监听器 | Load Balance Listener | 负载均衡服务监听器，包括监听端口、负载均衡策略和健康检查配置等，每个监听项对应后端的一个应用服务 |
| 后端服务器 | Real Server | 接受负载均衡分发请求的一组云服务器实例，负载均衡服务将访问请求按照用户设定的规则转发到这一组后端 CVM 上进行处理 |
| 虚拟服务地址 | Virtual IP | 系统分配的服务地址，当前为 IP 地址。用户可以选择该服务地址是否对外公开，来分别创建公网和私网类型的负载均衡服务 |

## 2.负载均衡分类
### 1).根据原理分类
* 四层负载均衡, 传输层的负载均衡，主要是根据vip和端口信息进行负载均衡。ip+port下可以绑定集群。
    * 负载均衡实例会直接将请求转发到后端实例，而不修改任何数据包(除了将目标ip和端口修改为后端服务器的ip和端口)。负载均衡收到请求之后，会尝试在监听器配置中指定的端口上打开与后端实例的 TCP 连接。
    * CLB在收到SYN包的时候，就会直接转发给后端的服务器，CLB此时类似于一个路由器。
* 七层负载均衡, 应用层的负载均衡，主要是更加应用层的信息来进行负载均衡。可以根据域名+URL下可以绑定集群
    * 七层负载均衡器需要先代理后端服务器和客户端建立连接(三次握手)后，才可能接受到客户端发送的真正应用层内容的报文，然后再根据该报文中的特定字段，再加上负载均衡设备设置的服务器选择方式，决定最终选择的内部服务器。
### 2).根据新老分类
* 传统型CLB
* 应用型CLB

## 3.公网内网
公网型负载均衡实例通过 Internet 从客户端获取请求，并向绑定监听器的后端服务器分发这些请求。创建负载均衡器后，腾讯云会给公网负载均衡器分配一个公网域名 （传统型）和 一个 VIP 地址，DNS 服务器将会对域名及 VIP 地址进行解析，公网负载均衡也支持用户添加 CNAME 和 A 记录的绑定，将其映射到用户易读的自定义域名上。公网负载均衡实例均会被分配固定的 BGP 公网 IP，支持接收客户端的 HTTP、HTTPS、TCP、UDP 等请求转发。同时支持会话保持、健康检查等所有腾讯云负载均衡提供的服务。有关公网负载均衡实例使用的限制，请参见 使用约束。

## 4.会话保持
会话保持可使得来自同一 IP 的请求被转发到同一台后端服务器上。默认情况下，负载均衡会将每个请求分别路由到不同后端服务器实例负载。但是，您可以使用会话保持功能使特定用户的请求被路由到同一台后端服务器实例上，这样可以使某些需要保持会话的应用程序（如购物车）合理地工作。

会话保持是负载均衡最常见的问题之一，也是一个相对比较复杂的问题。会话保持有时候又叫做粘滞会话（Sticky Sessions）。会话保持是指在负载均衡器上的一种机制，可以识别客户端与服务器之间交互过程的关连性，在作负载均衡的同时还保证一系列相关连的访问请求会保持分配到一台服务器上｡

* 四层会话保持，四层转发情境支持简单会话保持能力，会话保持时间可设为 30-3600 秒中的任意整数值，超过该时间阈值，会话中无新请求则断开连接。
* 七层会话保持，七层转发情境支持基于 cookie 插入的会话保持能力（由负载均衡器向客户端植入 cookie），会话保持可选时间为30-3600秒。

### 会话保持方案：
* 简单会话保持
    * 负载均衡器在作负载均衡时根据访问请求的源地址作为判断关连会话的依据。
    * 对来自同一 IP 地址的所有访问请求在作负载均衡时都会被保持到一台服务器上去｡
    * 只需要根据数据包三､四层的信息就可以实现，效率比较高。
* Session的会话保持
    * 数据库存放
    * 文件系统存放
    * Memcached存放
* Cookie的会话保持
    * 在基于 cookie 模式下负载均衡器负责插入 cookie，后端服务器无需作出任何修改。
    * 当客户端进行第一次请求时，客户端的 HTTP request（不带 cookie）进入负载均衡器， CLB 根据负载平衡算法策略选择后端一台服务器，并将请求发送至该服务器
    * 后端服务器的 HTTP response（不带 cookie）被发回给负载均衡器。接下来负载均衡器将向该后端服务器插入 cookie 并将 HTTP response 返回到客户端。
    * 当客户请求再次发生时，客户 HTTP request（带有上次负载均衡器插入的 cookie）进入 CLB，然后 CLB 读出 cookie 里的会话保持数值，将 HTTP request发到指定的服务器，然后后端服务器进行请求回复。
    * 由于服务器并不写入cookie，HTTP response 将不带 cookie，该 HTTP response 再次经过进入 CLB 时，CLB 将写入更新后的会话保持 cookie。

## 5.健康检测
* 四层转发健康检查配置，对于TCP的业务，使用 SYN 包进行探测。对于 UDP 业务，使用 Ping 进行检查。
* 七层转发健康检查配置，七层转发的健康检查机制由负载均衡器向后端服务器发送 HTTP 请求来检测后端服务，负载均衡器会通过 HTTP 返回值判断服务是否正常。
### 健康检查频率过高问题
实际上是CLB可能并非一台机器，而是多台机器，配置的健康检查时间是CLB单机进行健康检查的频率。CLB会根据客户端请求，自适应的加大负载均衡集群。

该实现方案的优势是：效率高，探测精准，避免误剔除。比如 CLB 实例集群的 8 台物理机中，其中 1 台判断失败，仅那 1 台机器不再转发流量，另外 7 台的流量是正常的。

### 建议
* 建议跨多个可用区配置负载均衡器的后端CVM实例。如果一个可用区变得不可用，负载均衡器会将流量路由到其他可用区正常运行的实例上去，从而屏蔽可用区故障引起的服务中断问题。